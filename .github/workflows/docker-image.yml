name: Build & Push Docker image to Docker Hub (Enhanced)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Docker Tag'
        required: false
        default: 'latest'
        type: string
      force_rebuild:
        description: 'Force rebuild without cache'
        required: false
        default: false
        type: boolean
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/shiyutv
  REGISTRY: docker.io

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  actions: write

jobs:
  # é¢„æ¸…ç†ä»»åŠ¡ - é¿å…å†²çª
  pre-cleanup:
    name: ğŸ§¹ Pre-build Cleanup
    runs-on: ubuntu-latest
    if: github.event.inputs.force_rebuild == 'true'
    steps:
      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ—‘ï¸ Clean conflicting tags
        run: |
          TAG=${{ github.event.inputs.tag || 'latest' }}
          echo "ğŸ§¹ Attempting to clean potentially conflicting tags..."
          
          # å°è¯•åˆ é™¤å¯èƒ½å­˜åœ¨çš„æŸåæ ‡ç­¾ (å¿½ç•¥é”™è¯¯)
          docker buildx imagetools inspect "${{ env.IMAGE_NAME }}:${TAG}" >/dev/null 2>&1 && \
            echo "â„¹ï¸ Existing tag found, will overwrite" || \
            echo "â„¹ï¸ No existing tag found"

  # ä¸»æ„å»ºä»»åŠ¡
  build-and-push:
    name: ğŸš€ Build & Push Multi-Platform Image
    runs-on: ubuntu-latest
    needs: [pre-cleanup]
    if: always() && (needs.pre-cleanup.result == 'success' || needs.pre-cleanup.result == 'skipped')
    steps:
      - name: âš¡ Maximize build space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean
          df -h

      - name: ğŸ“¥ Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # Node.js ç¯å¢ƒè®¾ç½®
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4

      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      - name: ğŸ“œ Generate version and changelog
        run: node scripts/convert-changelog.js

      # Docker ç¯å¢ƒè®¾ç½® - å¢å¼ºç‰ˆ
      - name: ğŸ¯ Setup QEMU (Enhanced)
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64
          image: tonistiigi/binfmt:qemu-v7.0.0

      - name: ğŸ”§ Setup Docker Buildx (Enhanced)
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container
          driver-opts: |
            image=moby/buildkit:buildx-stable-1
            network=host
          use: true

      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          logout: false

      # ç”Ÿæˆå”¯ä¸€æ ‡ç­¾é¿å…å†²çª
      - name: ğŸ·ï¸ Generate unique tags
        id: tags
        run: |
          TAG=${{ github.event.inputs.tag || 'latest' }}
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          COMMIT_SHA=${GITHUB_SHA::8}
          
          # ä¸»æ ‡ç­¾
          MAIN_TAG="${TAG}"
          # å¤‡ä»½æ ‡ç­¾ï¼ˆæ—¶é—´æˆ³ï¼‰
          BACKUP_TAG="${TAG}-${TIMESTAMP}"
          # æäº¤æ ‡ç­¾
          COMMIT_TAG="${TAG}-${COMMIT_SHA}"
          
          echo "main_tag=${MAIN_TAG}" >> $GITHUB_OUTPUT
          echo "backup_tag=${BACKUP_TAG}" >> $GITHUB_OUTPUT
          echo "commit_tag=${COMMIT_TAG}" >> $GITHUB_OUTPUT
          echo "all_tags=${MAIN_TAG},${BACKUP_TAG},${COMMIT_TAG}" >> $GITHUB_OUTPUT

      # å¼ºåŒ–æ„å»ºæ­¥éª¤ - é¿å… manifest é—®é¢˜
      - name: ğŸš€ Build and push (Anti-corruption)
        id: build
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 60
          max_attempts: 3
          retry_wait_seconds: 60
          command: |
            # æ¸…ç†æœ¬åœ° buildx ç¼“å­˜ä»¥é¿å…æŸå
            docker buildx prune -f || true
            
            # ä½¿ç”¨å¼ºåŒ–å‚æ•°æ„å»º
            docker buildx build \
              --context . \
              --file ./Dockerfile \
              --platform linux/amd64,linux/arm64 \
              --push \
              --tags ${{ steps.tags.outputs.all_tags }} \
              --cache-from type=gha,scope=${{ github.workflow }}-${{ github.ref_name }} \
              --cache-to type=gha,mode=max,scope=${{ github.workflow }}-${{ github.ref_name }} \
              --provenance=false \
              --sbom=false \
              --build-arg BUILDKIT_INLINE_CACHE=1 \
              --metadata-file /tmp/metadata.json \
              --progress=plain

      # å…³é”®ï¼šéªŒè¯å’Œä¿®å¤ manifest
      - name: ğŸ” Verify and fix manifest
        run: |
          MAIN_TAG="${{ steps.tags.outputs.main_tag }}"
          echo "ğŸ” Comprehensive manifest verification..."
          
          # ç­‰å¾… Docker Hub ä¼ æ’­
          echo "â³ Waiting for Docker Hub propagation..."
          sleep 15
          
          # éªŒè¯å‡½æ•°
          verify_image() {
            local tag=$1
            local max_attempts=5
            local wait_time=10
            
            for attempt in $(seq 1 $max_attempts); do
              echo "ğŸ” Verifying $tag (attempt $attempt/$max_attempts)..."
              
              if docker buildx imagetools inspect "${{ env.IMAGE_NAME }}:${tag}" >/dev/null 2>&1; then
                echo "âœ… $tag verified successfully"
                
                # è¯¦ç»†æ£€æŸ¥ manifest
                MANIFEST_INFO=$(docker buildx imagetools inspect "${{ env.IMAGE_NAME }}:${tag}" --format '{{json .}}' 2>/dev/null || echo "")
                if [[ -n "$MANIFEST_INFO" && "$MANIFEST_INFO" != *"error"* ]]; then
                  echo "âœ… Manifest is healthy"
                  docker buildx imagetools inspect "${{ env.IMAGE_NAME }}:${tag}"
                  return 0
                else
                  echo "âš ï¸ Manifest may be corrupted"
                fi
              fi
              
              if [ $attempt -lt $max_attempts ]; then
                echo "â³ Verification failed, waiting ${wait_time}s..."
                sleep $wait_time
                wait_time=$((wait_time + 5))
              fi
            done
            
            echo "âŒ Verification failed for $tag"
            return 1
          }
          
          # éªŒè¯ä¸»æ ‡ç­¾
          if verify_image "$MAIN_TAG"; then
            echo "ğŸ‰ Main tag verified successfully!"
          else
            echo "âŒ Main tag verification failed"
            echo "ğŸ”§ Attempting manifest recreation..."
            
            # å°è¯•é‡æ–°åˆ›å»º manifest (ä½¿ç”¨å¤‡ä»½æ ‡ç­¾)
            BACKUP_TAG="${{ steps.tags.outputs.backup_tag }}"
            if verify_image "$BACKUP_TAG"; then
              echo "ğŸ“‹ Recreating manifest from backup..."
              docker buildx imagetools create \
                --tag "${{ env.IMAGE_NAME }}:${MAIN_TAG}" \
                "${{ env.IMAGE_NAME }}:${BACKUP_TAG}" || echo "âš ï¸ Manual manifest recreation failed"
            fi
            
            # æœ€ç»ˆéªŒè¯
            sleep 10
            if ! verify_image "$MAIN_TAG"; then
              echo "âŒ Critical: Unable to create valid manifest"
              exit 1
            fi
          fi

      # å¥åº·æ£€æŸ¥
      - name: ğŸ¥ Health check
        run: |
          echo "ğŸ¥ Performing health check..."
          TAG="${{ steps.tags.outputs.main_tag }}"
          
          # æ£€æŸ¥é•œåƒæ˜¯å¦å¯ä»¥è¢«æ‹‰å–
          echo "ğŸ”„ Testing image pull..."
          if docker pull "${{ env.IMAGE_NAME }}:${TAG}" >/dev/null 2>&1; then
            echo "âœ… Image can be pulled successfully"
          else
            echo "âš ï¸ Image pull test failed (may be temporary)"
          fi
          
          # æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
          echo "ğŸ“Š Final image status:"
          docker buildx imagetools inspect "${{ env.IMAGE_NAME }}:${TAG}" || echo "âš ï¸ Unable to inspect"

      # æˆåŠŸæŠ¥å‘Š
      - name: ğŸ“Š Success report
        run: |
          echo "ğŸ‰ Build completed successfully!"
          echo "âœ… Tags pushed: ${{ steps.tags.outputs.all_tags }}"
          echo "âœ… Platforms: linux/amd64, linux/arm64"
          echo "âœ… Anti-corruption measures applied"
          echo "âœ… Manifest verification passed"
          echo ""
          echo "ğŸ”— Docker Hub: https://hub.docker.com/r/${{ env.IMAGE_NAME }}"

  # æ¸…ç†ä»»åŠ¡
  cleanup:
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: always()
    steps:
      - name: ğŸ§¹ Cleanup workflow runs
        uses: Mattraks/delete-workflow-runs@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 2
          keep_minimum_runs: 3
